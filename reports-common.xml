<project name="reports-common" >
    <description>Common attributes and targets for source code reports</description>

    <!-- Get the basedir where our report is running, without relying on 'basedir' -->
    <dirname property="tool.home"       file="${ant.file}"/>

    <!-- Properties can be overridden at the code project or individual report level -->
    <property file="${project.root}/report.properties.local"/>
    <property file="${project.root}/report.properties"/>

    <property file="${tool.home}/report.properties.local"/>    
    <property file="${tool.home}/report.properties"/>
    
    <property file="${report.script.dir}/${project.properties.local}"/>
    <property file="${report.script.dir}/${project.properties}"/>
    <property file="${report.script.dir}/report.properties.local"/>
    <property file="${report.script.dir}/report.properties"/>

    <!-- Classpath for source code dependencies -->
    <path id="build.classpath">
        <fileset dir="${lib.dir}">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="${bin.dir}"/>
    </path>

    <!-- Classpath for tool dependencies -->
    <path id="tool.classpath">
        <fileset dir="${tool.home}">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="${tool.home}"/>
        <path refid="build.classpath"/>
    </path>

    <!-- Classpath for report tasks -->
    <path id="report.classpath">
        <path refid="tool.classpath"/>
    </path>

    <tstamp>
        <format pattern="MM-dd-yyyy-hhmm" property="report.timestamp"/>
    </tstamp>

    <!-- Template target for reports -->
    <target name="report" depends="init, run-report, post-process, transform"
        description="Template target that defines the steps for creating a report"/>
    
    <!-- Shared tasks -->
    <target name="disabled" description="An empty task to allow the report to be disabled"/>
    
    <target name="init"
        description="Basic report setup">
        <mkdir dir="${gen.report.dir}"/>

        <tstamp>
            <format pattern="MM-dd-yyyy-hhmm" property="report.start.timestamp"/>
        </tstamp>
        <echo message="Starting ${ant.project.name} at ${report.start.timestamp}"/>
    </target>

    <target name="post-process" description="Follow-up processing after a report is finished">
	    <!-- Generate an element in the summary report for this tool -->
        <echo message="&lt;report name=&quot;${ant.project.name}&quot; description=&quot;${report.description}&quot; time=&quot;${report.timestamp}&quot; /&gt;" 
            file="${project.report.summary}" append="yes"/> 

        <tstamp>
            <format pattern="MM-dd-yyyy-hhmm" property="report.stop.timestamp"/>
        </tstamp>
        <echo message="Finishing ${ant.project.name} at ${report.stop.timestamp}"/>
    </target>
    
    <target name="transform" depends="check-stylesheet" if="stylesheet.present">
        <report-style/>
    </target>

    <target name="check-stylesheet"
        description="Check whether this report uses a stylesheet to generate HTML">

        <!-- Check for it as either a loose file or as a resource on the classpath -->
        <available
            property="stylesheet.present"
            file="${report.stylesheet}"
            classpathref="tool.classpath"/>

        <available
            property="stylesheet.present"
            resource="${report.stylesheet}"
            classpathref="tool.classpath"/>
    </target>

    <!-- Common macrodefs -->
    <macrodef name="report-style">
        <attribute name="input.file" default="${gen.report.dir}/${report.name}.xml"/>
        <attribute name="output.file" default="${gen.report.dir}/${styled.report.name}.html"/>
        <attribute name="stylesheet" default="${report.stylesheet}"/>
        <element name="extra.params" optional="true"/>
        <sequential>
            <style basedir="." destdir="."
                in="@{input.file}" 
                out="@{output.file}"
                style="@{stylesheet}">
              <param name="project" expression="${src.project.name}" />
              <param name="today" expression="${report.timestamp}" />
              <extra.params/>
            </style>
        </sequential>
    </macrodef>
    
</project>
